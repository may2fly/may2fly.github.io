---
layout: post
title: 网络层协议
subtitle:  
categories: 网络协议
---

网络层或者IP层的任务就是提供主机到主机之间的连通性，负责将数据包从源地址传输到目标地址。网络层通过使用IP地址对数据包进行路由，以便它们能够通过多个网络中的路由器和交换机转发到目标地址。

# 1、网际协议版本4(IPv4)
IP地址是计算机网络中用来唯一标识一台设备的一组数字。IPv4地址使用32位（4字节）地址，其中每个地址被分成四个8位的字段，每个字段用十进制表示。由于IPv4地址空间有限，随着IPv4地址的不断分配，地址枯竭问题日益突出。

IP地址被划分为网络部分和主机部分。网络部分负责表示所在的逻辑网络区域，主机部分表示该主机在网段中的具体逻辑位置。同一网络区域中所有主机的网络部分是同一个。
当IP数据包在网络中传递时，路由器只关心目的IP地址的网络部分，通过识别IP地址的网络部分为IP数据包进行路由操作。而只有当数据包达到了目的的网段以后，才通过IP地址的主机部分查找具体的接收主机。

## 地址分类
IP地址分为A、B、C、D、E五类，其中A、B、C类地址称为主类网，其网络部分和主机部分的长短各不相同。
在主类网地址中，有一部分被用做了私有地址。私有地址是不可以在互联网上使用的，是在企业或组织内部局域网上使用的IP地址。可以不为局域网中的主机分配互联网可用的地址，从而节约有限的IP地址资源。以下是五类地址分类介绍

| 分类 | 范围 | 私有地址 | 规模 | 私有地址 |
| :------ |:--- | :--- | :--- |
| A类地址 | 第1个八位以0开头的地址，即第1个八位是00000001~01111111（二进制），1~127（十进制）的IP地址。其中，以01111111（127）开头的地址，即127.0.0.0网段的地址是测试地址，不可分配。 | 整个10.0.0.0网络的所有地址都是私有地址 | 网段一共有125（2的7次方-3）个，每个网段中可以有16777214（2的24次方-2）台主机。适合分配给规模特别大的网络使用 |
| B类地址 | 第1个八位以10开头的地址，即第1个八位是10000000~10111111（二进制），128~191（十进制）的IP地址。 | 172.16.0.0~172.31.255.255范围内的所有地址是私有地址。 | 网段一共有16368（2的14次方-16）个，每个网段中可以有65534（2的16次方-2）台主机。适合分配给规模大的网络使用。 |
| C类地址 | 第1个八位以110开头的地址，即第1个八位是11000000~11011111（二进制），192~223（十进制）的IP地址。 | 192.168.1.0~192.168.255.255范围内的所有地址是私有地址。 | 网段一共有2096896（2的21次方-256）个，每个网段中可以有254（2的8次方-2）台主机。适合分配给规模小的网络使用。 |
| D类地址 | 第1个八位以1110开头的地址，即第1个八位是11100000~11101111（二进制），224~239（十进制）的IP地址。 | 无 | 保留地址，不标识网络，用于多点广播。本文不做介绍。 |
| E类地址 | 第1个八位以11110开头的地址，即第个八位是11110000（二进制），240（十进制）开头的IP地址。 | 无 | 保留地址，不标识网络，用于做研究。 |

## 1.1 子网划分
IP地址的数量是有限的、紧缺的。当网络规模较少，不足以使用一个主类网地址段的时候，会产生地址浪费。
子网允许将一个大的网络划分成许多小的网络，以方便使用和管理。

子网划分的术语叫做VLSM（可变长子网掩码，Variable Length Subnet Mask），这里的子网掩码，又称为网络掩码，就是来解决子网划分的问题。子网掩码和IP地址一样也是32位，用二进制表示是一堆连续的1、后面接一堆连续的0。值为1的位对应IP地址中的网络部分（含子网部分）；值为0的位对应主机部分。当然，子网掩码，也可以用点分十进制表示，或者直接用掩码长度表示。

子网划分后：

每个子网的第1个地址，即主机部分全部为0的地址，例如示例中的192.168.1.0，称为网络地址或网段地址，用于标识一个子网，相当于一个“面”的概念。
每个子网的最后1个地址，即主机部分全部为1的地址，例如示例中的192.168.1.63，称为广播地址，是用于向子网中所有主机发送数据的特殊地址。
网络地址和广播地址，不能作为主机地址。所以这个子网的IP地址一共有64个，除去2个，可以用来给最多62台主机分配。

子网划分的另一个目的也是用来分割广播域，以避免在网络中引发大面积的广播风暴。

## 1.1 网络地址转换（NAT）


P4 寻址在构建主机到主机之间连通性时，首先需要有一个全球性的和唯一的标识主机的寻址方案。主机经过一个接口(如以太网接口卡)连接到一个网络上。某些主机和路由器可以配备多个网络接口。对于每个网络接口，需要使用一个地址来标识接口以便发送和接收分组。为了能够在数十亿主机之间找到一个网络接口，我们需要一种层次化的结构来全局地组织和定位P 地址。IP 地址的层次化结构与邮政地址非常相似。我们家庭的邮政地址是由编号、街道、城市和国家组成，所以邮局能够很容易地确定我们的邮件要发送到哪里。同样，1P 寻址方案具有层次化的结构，以便中间路山器很容易地识别分组应该发送到的网络。
# 2、IPV6

# 3、互联网控制报文协议(ICMP)
ICMP（Internet Control Message Protocol）是互联网控制报文协议，是一种在TCP/IP网络上发送错误消息的协议。它主要是用于网络设备之间传递控制信息和错误消息，以便在网络中快速诊断和解决问题。ICMP是IP协议的一个扩展，通常被认为是IP协议的一个组成部分。

ICMP主要有两种类型的消息：错误报文和请求报文。错误报文通常是由路由器或主机发送，用于通知数据包无法传输或到达目的地，或者存在其他问题。请求报文通常是由主机发送，用于检测目标主机是否可达或者进行路由器探测等操作。

ICMP报文通常被用于以下几个方面：

检测网络连接：例如，当主机无法连接到目标主机时，可以使用ICMP请求报文来检测目标主机是否可达。
诊断网络问题：例如，当主机无法接收目标主机发送的数据包时，可以使用ICMP错误报文来诊断问题所在。
改善网络性能：例如，当主机向目标主机发送大量数据时，可以使用ICMP通告报文来通知目标主机增加缓存大小等操作。
总之，ICMP是一个在互联网中扮演重要角色的协议，它能够帮助我们快速诊断和解决网络问题，提高网络的可靠性和性能。

主要用于网络故障排除和诊断，包括ping测试和traceroute命令。

# 4、ARP
ARP (Address Resolution Protocol): 用于将IP地址转换为物理地址（如MAC地址），以便数据包能够在本地网络上正确地转发。

# 5、RARP
RARP (Reverse Address Resolution Protocol): 用于将物理地址转换为IP地址，通常用于从磁盘less工作站引导时获得IP地址。

# 6、边界网关协议(BGP)
边界网关协议（Border Gateway Protocol，BGP）是一种运行在TCP协议之上的自治系统（AS）之间交换路由信息的协议。BGP通常被用于互联网服务提供商（ISP）之间的路由交换，但也可以被用于在同一自治系统内部的路由交换。

BGP的主要功能是通过交换路由信息来确定AS之间的最佳路径，以实现可靠、快速的数据传输。BGP使用一种基于前缀的路由选择算法，称为最长前缀匹配。当多个路由匹配时，BGP将选择最长的前缀，即最匹配的路由。

BGP是一种可靠的路由协议，它可以确保路由信息的可靠交换，并可以检测和避免路由环路。BGP还支持路由策略和过滤功能，这使得管理员可以控制和优化其AS的路由表。

BGP还支持多种不同的路由类型，包括内部网关协议（IGP）和外部网关协议（EGP）。IGP路由用于在同一自治系统内部传输数据，而EGP路由则用于在不同自治系统之间传输数据。

总之，BGP是互联网中最重要的路由协议之一，它使得不同的自治系统能够相互通信，并确保了互联网的可靠性和稳定性。

# 7、IPSEC
IPsec（Internet Protocol Security）是一组用于IPv4和IPv6协议族的网络安全协议，用于提供安全的IP通信。IPsec提供了加密、完整性和认证等安全服务，可用于加密网络传输中的数据，以保护数据的机密性和完整性。

IPsec协议通过使用加密技术，确保网络数据在传输过程中得到保护。它可以提供对所有传输层协议，包括TCP、UDP和ICMP的安全性。IPsec是一个端到端的协议，因此它可以在两个不同的网络端点之间提供加密和身份验证。

IPsec协议有两种模式：传输模式和隧道模式。传输模式用于直接连接的两个网络端点之间的数据传输，隧道模式用于在不同网络之间的通信。

IPsec协议包含两个主要协议：认证头（AH）和封装安全载荷（ESP）。认证头协议提供数据完整性和认证，封装安全载荷协议提供加密和身份验证。

IPsec协议可用于许多网络安全应用程序，如VPN（Virtual Private Network）连接、远程访问、无线网络保护和IPv6互联网安全等。

# 8、开放最短路径优先 (OSPF) 
开放最短路径优先（Open Shortest Path First，简称OSPF）是一种内部网关协议（IGP），用于在自治系统（AS）内部的路由器之间进行动态路由选择。OSPF是基于链路状态算法的协议，其目的是在AS内部构建一个带有标准化成本指标的最短路径树。

OSPF在AS内部采用分层的体系结构，包括一个核心区域（Backbone Area）和多个非核心区域。核心区域包含所有的AS内部网络，而非核心区域则是AS内部的子网。

OSPF的工作过程可以概括为以下几个步骤：

发现相邻路由器：路由器通过发送Hello消息来发现相邻的OSPF路由器。在相邻路由器之间建立邻居关系后，它们可以交换链路状态信息。

构建链路状态数据库：每个OSPF路由器将收到的链路状态信息存储在自己的链路状态数据库（Link State Database，简称LSDB）中，然后使用Dijkstra算法计算最短路径树。

计算最短路径树：OSPF使用Dijkstra算法计算从当前路由器到其他所有路由器的最短路径树。计算完成后，每个路由器都可以确定到其他路由器的最短路径，并将此信息传递给其它OSPF路由器。

建立路由表：每个OSPF路由器根据自己的最短路径树和链路状态数据库生成自己的路由表，并将其路由表信息发送给其它OSPF路由器。

总之，OSPF是一种高效的路由协议，它可以支持大型企业和互联网服务提供商的网络环境，并且可以提供快速、可靠的路由选择和动态路由调整。
